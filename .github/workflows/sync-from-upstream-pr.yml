name: Upstream Sync & Auto Merge

on:
  schedule:
    - cron: '0 3 * * *'        # æ¯æ—¥ 03:00 UTC è‡ªåŠ¨è¿è¡Œ
  workflow_dispatch: {}        # æ”¯æŒæ‰‹åŠ¨è§¦å‘

permissions:
  contents: write
  pull-requests: write

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ Checkout upstream repo (ä¸Šæ¸¸)
      - name: Checkout upstream repo
        uses: actions/checkout@v4
        with:
          repository: ycdxsb/PocOrExp_in_Github
          path: upstream
          token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}

      # 2ï¸âƒ£ Checkout your fork (ç›®æ ‡)
      - name: Checkout your fork
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}
          path: fork
          token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}

      # 3ï¸âƒ£ Rsync å·®å¼‚å¹¶æäº¤
      - name: Sync files from upstream to fork
        run: |
          echo "=== å¼€å§‹åŒæ­¥ upstream â†’ fork ==="
          rsync -av --delete --exclude='.git' --exclude='.github/workflows/*' upstream/ fork/
          cd fork
          git config user.name "github-actions[bot]"
          git config user.email "actions@github.com"

          echo "=== æ£€æŸ¥å·®å¼‚ ==="
          git status
          git add -A
          if git diff --cached --quiet; then
            echo "âœ… æ²¡æœ‰æ£€æµ‹åˆ°å˜æ›´ï¼Œfork å·²ä¸ upstream å®Œå…¨ä¸€è‡´ã€‚"
            echo "::notice title=Sync Result::âœ… æ— æ›´æ–° â€” Fork å·²æ˜¯æœ€æ–°ç‰ˆæœ¬ã€‚"
            exit 0
          fi

          echo "ğŸŸ¢ æ£€æµ‹åˆ°å˜æ›´ï¼Œå‡†å¤‡æäº¤..."
          git commit -m "chore(sync): update from upstream $(date -u +'%Y-%m-%d %H:%M:%S UTC')"

      # 4ï¸âƒ£ åˆ›å»º PR
      - name: Create Pull Request
        id: cpr
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
          path: fork
          branch: sync/upstream-sync
          base: main
          title: "Sync from upstream ycdxsb/PocOrExp_in_Github"
          body: |
            Automated synchronization from upstream repository.

            Triggered by workflow **${{ github.workflow }}** at ${{ github.event_name }}.
          commit-message: "chore(sync): update from upstream"
          labels: "sync, automated"

      # 5ï¸âƒ£ è¾“å‡º PR é“¾æ¥æˆ–æç¤º
      - name: Print PR link or notice
        run: |
          if [ "${{ steps.cpr.outputs.pull-request-number }}" != "" ]; then
            echo "ğŸŸ¢ å·²åˆ›å»º PR #${{ steps.cpr.outputs.pull-request-number }}ï¼š"
            echo "ğŸ”— ${{ steps.cpr.outputs.pull-request-url }}"
            echo "::notice title=PR Created::ğŸŸ¢ Pull Request å·²åˆ›å»º: ${{ steps.cpr.outputs.pull-request-url }}"
          else
            echo "âœ… æ²¡æœ‰æ£€æµ‹åˆ°å˜æ›´æˆ– PR å·²å­˜åœ¨ã€‚"
            echo "::notice title=Sync Result::âœ… æ— éœ€åˆ›å»º PRã€‚"
          fi

      # 6ï¸âƒ£ è‡ªåŠ¨åˆå¹¶ï¼ˆè‹¥ PR å­˜åœ¨ä¸”æ— å†²çªï¼‰
      - name: Auto merge PR if clean
        if: ${{ steps.cpr.outputs.pull-request-number != '' }}
        uses: peter-evans/enable-pull-request-automerge@v3
        with:
          token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
          pull-request-number: ${{ steps.cpr.outputs.pull-request-number }}
          merge-method: squash   # ä¹Ÿå¯æ”¹ä¸º merge/rebase

      # 7ï¸âƒ£ æ¸…ç†å·²åˆå¹¶åˆ†æ”¯
      - name: Delete branch after merge
        if: ${{ steps.cpr.outputs.pull-request-number != '' }}
        run: |
          echo "ğŸ§¹ æ¸…ç†åŒæ­¥åˆ†æ”¯ sync/upstream-sync ..."
          gh pr merge ${{ steps.cpr.outputs.pull-request-number }} --squash --delete-branch --auto --repo "${{ github.repository }}"
        env:
          GH_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
